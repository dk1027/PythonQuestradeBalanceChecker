{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description" : "Questrade Balance Checker Stack",
    "Resources" : {
        "QuestradeBalanceCheckerRole" : {
            "Type" : "AWS::IAM::Role",
            "Properties" : {
                "AssumeRolePolicyDocument" : {
                    "Version" : "2012-10-17",
                    "Statement" : [
                        {
                            "Effect" : "Allow",
                            "Principal" : {
                                "Service" : ["lambda.amazonaws.com"]
                            },
                            "Action" : ["sts:AssumeRole"]
                        }]
                },
                "Path" : "/"
            }
        },
        "QuestradeBalanceCheckerBucket" : {
          "Type" : "AWS::S3::Bucket",
          "Properties" : {
              "AccessControl" : "BucketOwnerFullControl",
              "BucketName" : "questrade-balance-checker-bucket"
          }
        },
        "QuestradeBalanceCheckerPolicy" : {
            "DependsOn" : [
                "QuestradeBalanceCheckerRole"
            ],
            "Type" : "AWS::IAM::Policy",
            "Properties" : {
                "PolicyName" : "QuestradeBalanceCheckerPolicy",
                "Roles" : [
                    {"Ref" : "QuestradeBalanceCheckerRole"}
                ],
                "PolicyDocument" : {
                    "Version" : "2012-10-17",
                    "Statement" : [
                        {
                            "Effect": "Allow",
                            "Action": "s3:*",
                            "Resource": {"Fn::Join": ["/", [{"Fn::GetAtt" : ["QuestradeBalanceCheckerBucket", "Arn"]}, "*"]]}
                        }]
                }
            }
        },
        "QuestradeLambda" : {
            "Type" : "AWS::Lambda::Function",
            "DependsOn" : [
                "QuestradeBalanceCheckerBucket",
                "QuestradeBalanceCheckerPolicy",
                "QuestradeBalanceCheckerRole"],
            "Properties" : {
                "Code" : {
                      "ZipFile": { "Fn::Join": ["\n", [
                          "import json",
                          "def lambda_handler(event, context):",
                          "    print('Not yet initialized.')"]
                     ]}
                 },
                "Role" : {
                    "Fn::GetAtt" : ["QuestradeBalanceCheckerRole", "Arn"]
                },
                "Timeout" : 30,
                "FunctionName": "QuestradeBalanceCheck",
                "Handler" : "index.lambda_handler",
                "Runtime" : "python3.6",
                "MemorySize" : 128
            }
        }
    }
}
